---
// Intro - First-time visitor wow experience
---

<script is:inline>
  // Hide intro immediately if seen within 30 days (prevents flash)
  (function() {
    var lastSeen = localStorage.getItem('jack_intro_seen');
    var thirtyDays = 30 * 24 * 60 * 60 * 1000;
    if (lastSeen && (Date.now() - parseInt(lastSeen)) < thirtyDays) {
      document.documentElement.classList.add('intro-seen');
    } else {
      // Lock scroll while intro is active
      document.documentElement.classList.add('intro-active');
    }
  })();
</script>
<style is:inline>
  .intro-seen #intro-overlay { display: none !important; }
  .intro-active { overflow: hidden !important; }
  .intro-active body { overflow: hidden !important; }
</style>
<div id="intro-overlay" class="fixed inset-0 z-[100] bg-white dark:bg-neutral-950 flex items-center justify-center min-h-[100dvh]">
  <!-- Skip button (left) -->
  <button id="skip-intro" class="absolute top-6 left-6 px-4 py-2 bg-neutral-100 dark:bg-neutral-800 hover:bg-neutral-200 dark:hover:bg-neutral-700 text-neutral-600 dark:text-neutral-300 hover:text-neutral-900 dark:hover:text-white text-sm rounded-full transition-colors cursor-pointer">
    Skip
  </button>

  <!-- Theme Toggle (right) -->
  <div class="absolute top-6 right-6">
    <button
      id="intro-theme-toggle"
      type="button"
      class="w-8 h-8 rounded-full bg-neutral-100 dark:bg-neutral-800 flex items-center justify-center hover:bg-neutral-200 dark:hover:bg-neutral-700 transition-colors relative overflow-hidden cursor-pointer"
      aria-label="Toggle theme"
    >
      <!-- Sun icon (visible in dark mode) -->
      <svg class="w-6 h-6 text-yellow-500 absolute transition-all duration-300 ease-out opacity-0 dark:opacity-100 scale-50 dark:scale-100 rotate-90 dark:rotate-0" viewBox="0 0 24 24">
        <path fill="currentColor" fill-rule="evenodd" d="M13 3a1 1 0 1 0-2 0v2a1 1 0 1 0 2 0zM6.343 4.929A1 1 0 0 0 4.93 6.343l1.414 1.414a1 1 0 0 0 1.414-1.414zm12.728 1.414a1 1 0 0 0-1.414-1.414l-1.414 1.414a1 1 0 0 0 1.414 1.414zM12 7a5 5 0 1 0 0 10a5 5 0 0 0 0-10m-9 4a1 1 0 1 0 0 2h2a1 1 0 1 0 0-2zm16 0a1 1 0 1 0 0 2h2a1 1 0 1 0 0-2zM7.757 17.657a1 1 0 1 0-1.414-1.414l-1.414 1.414a1 1 0 1 0 1.414 1.414zm9.9-1.414a1 1 0 0 0-1.414 1.414l1.414 1.414a1 1 0 0 0 1.414-1.414zM13 19a1 1 0 1 0-2 0v2a1 1 0 1 0 2 0z" clip-rule="evenodd"/>
      </svg>
      <!-- Moon icon (visible in light mode) -->
      <svg class="w-5 h-5 text-indigo-400 absolute transition-all duration-300 ease-out opacity-100 dark:opacity-0 scale-100 dark:scale-50 rotate-0 dark:rotate-90" viewBox="0 0 24 24">
        <path fill="currentColor" d="M9.272 2.406a1 1 0 0 0-1.23-1.355C6.59 1.535 5.432 2.488 4.37 3.55a11.4 11.4 0 0 0 0 16.182c4.518 4.519 11.51 4.261 15.976-.205c1.062-1.062 2.014-2.22 2.498-3.673A1 1 0 0 0 21.55 14.6c-3.59 1.322-7.675.734-10.433-2.025C8.35 9.808 7.788 5.744 9.272 2.406"/>
      </svg>
    </button>
  </div>

  <!-- Center container -->
  <div class="w-full max-w-2xl px-6">
    <!-- Logo (starts centered, moves left to reveal JACK) -->
    <div id="intro-logo" class="flex items-center justify-center gap-3 mb-12 opacity-0 translate-y-8 transition-all duration-700">
      <img id="intro-logo-img" src={`${import.meta.env.BASE_URL}butler.svg`} alt="Jack The Butler" class="w-16 h-16 dark:invert -rotate-90 translate-x-12 transition-all duration-700" />
      <span id="intro-logo-text" class="text-3xl font-bold text-neutral-900 dark:text-white opacity-0 transition-opacity duration-500">JACK</span>
    </div>


    <!-- Chat container -->
    <div id="intro-chat">
      <!-- Messages will appear here -->
      <div id="intro-messages" class="space-y-4 mb-24 min-h-[200px]"></div>
    </div>
  </div>

  <!-- Input field (fixed at bottom) -->
  <div id="intro-input-container" class="fixed bottom-6 left-1/2 -translate-x-1/2 w-full max-w-2xl px-6 opacity-0 translate-y-4 transition-all duration-500">
    <div class="w-full px-5 py-4 rounded-2xl bg-neutral-100 dark:bg-neutral-900 border border-neutral-200 dark:border-neutral-700 text-neutral-900 dark:text-white">
      <span id="intro-input" class="text-neutral-700 dark:text-neutral-300"></span>
      <span class="inline-block w-0.5 h-5 bg-blue-500 animate-pulse ml-0.5 align-middle"></span>
    </div>
  </div>

  <!-- Gradient orbs for atmosphere -->
  <div class="absolute inset-0 overflow-hidden pointer-events-none">
    <div class="absolute top-1/4 left-1/4 w-96 h-96 bg-blue-500/20 dark:bg-blue-500/10 rounded-full blur-3xl"></div>
    <div class="absolute bottom-1/4 right-1/4 w-96 h-96 bg-emerald-500/20 dark:bg-emerald-500/10 rounded-full blur-3xl"></div>
  </div>
</div>

<style>
  .intro-message {
    opacity: 0;
    transform: translateY(10px);
    animation: messageIn 0.4s ease-out forwards;
  }

  @keyframes messageIn {
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .typing-cursor {
    display: inline-block;
    width: 2px;
    height: 1em;
    background: #3b82f6;
    animation: blink 1s step-end infinite;
    vertical-align: middle;
    margin-left: 2px;
  }

  @keyframes blink {
    50% { opacity: 0; }
  }

  .time-tick {
    display: inline-block;
    animation: tick 0.15s ease-out;
  }

  @keyframes tick {
    0% { transform: translateY(0); opacity: 1; }
    50% { transform: translateY(-8px); opacity: 0; }
    51% { transform: translateY(8px); opacity: 0; }
    100% { transform: translateY(0); opacity: 1; }
  }
</style>

<script>
  const INTRO_SEEN_KEY = 'jack_intro_seen';
  const THIRTY_DAYS_MS = 30 * 24 * 60 * 60 * 1000;

  // Check if user has seen intro within last 30 days
  const lastSeen = localStorage.getItem(INTRO_SEEN_KEY);
  const hasSeenIntro = lastSeen && (Date.now() - parseInt(lastSeen)) < THIRTY_DAYS_MS;

  const overlay = document.getElementById('intro-overlay');
  const skipBtn = document.getElementById('skip-intro');
  const logo = document.getElementById('intro-logo');
  const logoImg = document.getElementById('intro-logo-img');
  const logoText = document.getElementById('intro-logo-text');
    const chat = document.getElementById('intro-chat');
  const messages = document.getElementById('intro-messages');
  const inputContainer = document.getElementById('intro-input-container');
  const inputEl = document.getElementById('intro-input');

  // Conversation script - Real guest interaction demo at 3AM
  const conversation = [
    { type: 'time', text: '3:12 AM' },
    { type: 'user', text: 'Hey, our flight just got cancelled. Can we extend our stay by 2 nights?' },
    { type: 'ai', text: 'Of course! I\'ve extended your reservation in room 412 through <strong>Thursday.</strong> Same rate applies. I\'ve also notified housekeeping and <strong>rescheduled your spa appointment.</strong>' },
    { type: 'user', text: 'Wow that was fast. Thank you!' },
    { type: 'ai', text: 'Happy to help! I\'ve sent the updated confirmation to your email. If you need anything else tonight, I\'m here.' },
  ];

  function typeText(element: HTMLElement, text: string, speed = 40): Promise<void> {
    return new Promise((resolve) => {
      let i = 0;
      element.textContent = '';
      const interval = setInterval(() => {
        element.textContent += text[i];
        i++;
        if (i >= text.length) {
          clearInterval(interval);
          resolve();
        }
      }, speed);
    });
  }

  function addMessage(type: 'user' | 'ai', text: string): void {
    const msg = document.createElement('div');
    msg.className = `intro-message flex ${type === 'user' ? 'justify-end' : 'justify-start'}`;
    msg.innerHTML = `
      <div class="max-w-[80%] px-4 py-3 rounded-2xl ${
        type === 'user'
          ? 'bg-neutral-200 dark:bg-neutral-700 text-neutral-900 dark:text-white rounded-br-md'
          : 'bg-blue-600 text-white rounded-bl-md'
      }">
        <p class="text-sm">${text}</p>
      </div>
    `;
    messages?.appendChild(msg);
  }

  function sleep(ms: number): Promise<void> {
    return new Promise(resolve => setTimeout(resolve, ms));
  }

  async function runIntro(): Promise<void> {
    // Phase 1: Logo slides up and rotates
    await sleep(300);
    logo?.classList.remove('opacity-0', 'translate-y-8');
    logoImg?.classList.remove('-rotate-90');
    logoImg?.classList.add('rotate-0');

    // Phase 1b: Logo moves left and reveals "Jack" text
    await sleep(500);
    logoImg?.classList.remove('translate-x-12');
    logoText?.classList.remove('opacity-0');

    // Phase 2: Show time first
    await sleep(1000);

    // Phase 3: Conversation
    for (const msg of conversation) {
      if (msg.type === 'time') {
        // Show timestamp with counter animation
        const timeEl = document.createElement('div');
        timeEl.className = 'intro-message text-center text-neutral-600 dark:text-neutral-400 text-xs py-2';
        timeEl.innerHTML = '<span class="time-hour">3</span>:<span class="time-min">11</span> AM';
        messages?.appendChild(timeEl);
        await sleep(800);
        // Animate minute counter up by 1
        const minEl = timeEl.querySelector('.time-min');
        if (minEl) {
          minEl.classList.add('time-tick');
          await sleep(150);
          minEl.textContent = '12';
        }
        await sleep(400);
        // Show input field after time
        inputContainer?.classList.remove('opacity-0', 'translate-y-4');
        await sleep(300);
      } else if (msg.type === 'user') {
        // Type in input
        await typeText(inputEl!, msg.text, 35);
        await sleep(400);
        // Clear input and show as message
        if (inputEl) inputEl.textContent = '';
        addMessage('user', msg.text);
      } else {
        // AI thinking delay
        await sleep(600);
        addMessage('ai', msg.text);
      }
      await sleep(800);
    }

    // Phase 5: Hide input and show continue button
    await sleep(500);
    inputContainer?.classList.add('opacity-0', 'translate-y-4');
    await sleep(300);
    inputContainer!.style.display = 'none';

    const continueBtn = document.createElement('button');
    continueBtn.className = 'fixed bottom-6 left-1/2 -translate-x-1/2 px-8 py-4 bg-neutral-900 hover:bg-neutral-800 dark:bg-white dark:hover:bg-neutral-100 text-white dark:text-neutral-900 font-semibold rounded-full transition-all duration-500 opacity-0 translate-y-4 cursor-pointer whitespace-nowrap';
    continueBtn.textContent = 'Get Jack for Free â†’';
    continueBtn.onclick = endIntro;
    overlay?.appendChild(continueBtn);

    await sleep(50);
    continueBtn.classList.remove('opacity-0', 'translate-y-4');
  }

  function endIntro(): void {
    localStorage.setItem(INTRO_SEEN_KEY, Date.now().toString());
    // Unlock scroll
    document.documentElement.classList.remove('intro-active');
    overlay?.classList.add('opacity-0', 'pointer-events-none');
    overlay!.style.transition = 'opacity 0.5s ease-out';
    setTimeout(() => {
      overlay?.remove();
    }, 500);
  }

  // Skip button
  skipBtn?.addEventListener('click', endIntro);

  // Theme toggle with View Transitions API (same as main site)
  document.getElementById('intro-theme-toggle')?.addEventListener('click', function() {
    const isDark = document.documentElement.classList.contains('dark');
    const newTheme = isDark ? 'light' : 'dark';

    // Get button position for animation origin
    const rect = this.getBoundingClientRect();
    const x = rect.left + rect.width / 2;
    const y = rect.top + rect.height / 2;

    // Calculate the max radius needed to cover the screen
    const maxRadius = Math.hypot(
      Math.max(x, window.innerWidth - x),
      Math.max(y, window.innerHeight - y)
    );

    // Check for View Transitions API support
    if (document.startViewTransition) {
      document.documentElement.style.setProperty('--x', x + 'px');
      document.documentElement.style.setProperty('--y', y + 'px');
      document.documentElement.style.setProperty('--r', maxRadius + 'px');

      document.startViewTransition(function() {
        document.documentElement.classList.toggle('dark');
        localStorage.setItem('theme', newTheme);
      });
    } else {
      // Fallback for browsers without View Transitions
      document.documentElement.classList.toggle('dark');
      localStorage.setItem('theme', newTheme);
    }
  });

  // Keyboard skip (Escape or Space)
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' || e.key === ' ') {
      endIntro();
    }
  });

  // Run intro if not seen in last 30 days
  if (hasSeenIntro) {
    overlay?.remove();
    document.documentElement.classList.remove('intro-active');
  } else {
    runIntro();
  }
</script>
